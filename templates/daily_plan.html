{% extends "layout.html" %}
{% block content %}

{% set show_result = result and result|length > 0 %}

<h4 class="mb-4 fw-semibold">Daily Plan</h4>

{% if not show_result %}
<!-- ================= INPUT FORM ================= -->
<form method="post" class="card p-4 mb-4 shadow-sm mx-auto" style="max-width: 900px;">
  <div class="row mb-4 text-muted">
    <div class="col-md-4">
      <label class="form-label fw-semibold">Date</label>
      <input type="date" name="date" value="{{ today }}" class="form-control">
    </div>
    <div class="col-md-4">
      <label class="form-label fw-semibold">Shift Duration (min)</label>
      <input type="number" name="shift" value="480" class="form-control">
    </div>
  </div>

  <hr>

<div class="fw-semibold mb-3 fs-5 border-bottom pb-2">
  Production Plan
</div>

  {% for l in lines %}
  <div class="row mb-3 align-items-center">
    <div class="col-md-4 fw-semibold">
      {{ l.name }}
    </div>
    <div class="col-md-4">
      <input type="number"
            name="qty_{{ l.id }}"
            class="form-control form-control-lg"
            placeholder="Plan Qty">
    </div>
  </div>
  {% endfor %}

  <button class="btn btn-primary btn-lg w-100 mt-4">
    Generate Allocation
  </button>
</form>
{% endif %}

<!-- ================= RESULTS ================= -->
{% for r in result %}
<div class="card mb-5 shadow-sm">

  <!-- ================= STRONG HEADER ================= -->
  <div class="card-header bg-white border-bottom py-3">
    <div class="row align-items-center">
      <!-- Line Name -->
      <div class="col-md-4">
        <div class="text-muted small">Assembly Line</div>
        <div class="fs-4 fw-bold">{{ r.line }}</div>
      </div>

      <!-- Key Metrics -->
      <div class="col-md-6">
        <div class="row text-center">
          <div class="col">
            <div class="text-muted small">Plan Qty</div>
            <div class="fw-semibold fs-5">{{ r.plan }}</div>
          </div>
          <div class="col">
            <div class="text-muted small">Takt Time</div>
            <div class="fw-semibold fs-5">{{ r.takt }} s</div>
          </div>
          <div class="col">
            <div class="text-muted small">Shift</div>
            <div class="fw-semibold fs-5">{{ r.shift }} min</div>
          </div>
        </div>
      </div>

      <!-- Manpower Focus -->
      <div class="col-md-2 text-center">
        <div class="text-muted small">Manpower</div>
        <div class="display-6 fw-bold text-primary">
          {{ r.manpower_used }}
        </div>
        <div class="text-muted small">
          Required: {{ r.manpower_required }}
        </div>
      </div>
    </div>
  </div>

  <!-- ================= COLLAPSIBLE BODY ================= -->
  <div class="collapse show">
    <div class="card-body">

      <!-- ================= ALERTS ================= -->
      {% set alerts = [] %}
      {% for op in r.operators %}
        {% if op.status == 'over' %}
          {% set _ = alerts.append("‚ö†Ô∏è " ~ op.name ~ " overloaded (" ~ op.time ~ " sec)") %}
        {% elif op.status == 'under' %}
          {% set _ = alerts.append("‚ö†Ô∏è " ~ op.name ~ " underutilized (" ~ op.time ~ " sec)") %}
        {% endif %}
      {% endfor %}

      {% if alerts %}
      <div class="alert alert-warning mb-4">
        <strong>Review Required</strong>
        <ul class="mb-0 mt-2">
          {% for a in alerts %}
          <li>{{ a }}</li>
          {% endfor %}
        </ul>
      </div>
      {% else %}
      <div class="alert alert-success mb-4">
        All operators are within acceptable takt range.
      </div>
      {% endif %}

      <!-- ================= ALLOCATION TABLE ================= -->
      <div class="table-responsive">
        <table class="table table-sm">
          <thead>
            <tr>
              <th style="width: 8%">OP</th>
              <th>Assigned Activities</th>
              <th style="width: 10%">Time (s)</th>
              <th style="width: 6%">Status</th>
            </tr>
          </thead>
          <tbody>

          {% for op in r.operators %}
            <tr>
              <!-- OP -->
              <td class="fw-bold align-top">{{ op.name }}</td>

              <!-- ACTIVITIES -->
              <td>
                <ol class="mb-0 ps-3">
                  {% for a in op.acts %}
                    <li class="mb-1">
                      <span class="fw-semibold">{{ a.text }}</span>
                    </li>
                  {% endfor %}
                </ol>
              </td>

              <!-- TIME -->
              <td class="align-top fw-semibold">
                {{ op.time }}
              </td>

              <!-- STATUS -->
              <td class="align-top">
                {% if op.status == 'over' %}
                  üî¥
                {% elif op.status == 'under' %}
                  üü°
                {% else %}
                  üü¢
                {% endif %}
              </td>
            </tr>
          {% endfor %}

          </tbody>
        </table>
      </div>

      <hr class="my-3">
      <div class="d-flex justify-content-between align-items-center">
        <!-- LEFT: EXPORT / PRINT -->
        <div class="d-flex gap-2">
          <form method="post" action="{{ url_for('export_daily_plan') }}" class="d-inline">
            <input type="hidden" name="shift" value="{{ request.form.get('shift') }}">
            {% for l in lines %}
              <input type="hidden" name="qty_{{ l.id }}" value="{{ request.form.get('qty_' ~ l.id) }}">
            {% endfor %}
            <button class="btn btn-success btn-sm">
              Export Excel
            </button>
          </form>

          <form method="post"
                action="{{ url_for('print_daily_plan') }}"
                target="_blank"
                class="d-inline">
            <input type="hidden" name="shift" value="{{ request.form.get('shift') }}">
            {% for l in lines %}
              <input type="hidden" name="qty_{{ l.id }}" value="{{ request.form.get('qty_' ~ l.id) }}">
            {% endfor %}
            <button class="btn btn-outline-primary btn-sm">
              Print (A4)
            </button>
          </form>
        </div>

        <!-- RIGHT: CLEAR -->
        <a href="{{ url_for('daily_plan') }}"
          class="btn btn-outline-secondary btn-sm">
          Clear & New Plan
        </a>
      </div>

    </div>
  </div>
</div>
{% endfor %}

{% endblock %}
