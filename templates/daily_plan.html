{% extends "layout.html" %}
{% block content %}

{% set show_result = result and result|length > 0 %}

<!-- ======================================================
     PAGE TITLE
====================================================== -->
<div class="mb-4">
  <h4 class="mb-1 fw-semibold">Daily Line Planning</h4>
  <p class="text-muted">
    Enter todayâ€™s production intent to generate manpower and activity allocation.
  </p>
</div>

<!-- ======================================================
     INPUT SECTION (VISIBLE ONLY BEFORE GENERATION)
====================================================== -->
{% if not show_result %}
<form method="post"
      class="card mx-auto mb-5"
      style="max-width: 960px;">

  <div class="card-body">

    <!-- -------- BASIC CONTEXT -------- -->
    <div class="row mb-4">
      <div class="col-md-4">
        <label class="form-label fw-semibold">Date</label>
        <input type="date"
               name="date"
               value="{{ today }}"
               class="form-control">
      </div>

      <div class="col-md-4">
        <label class="form-label fw-semibold">Shift Duration (minutes)</label>
        <input type="number"
               name="shift"
               value="480"
               min="1"
               class="form-control"
               required>
      </div>
    </div>

    <hr class="my-4">

    <!-- -------- PLAN INPUT -------- -->
    <h6 class="fw-semibold mb-3">Production Plan</h6>

    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label fw-semibold">Assembly Line</label>
        <select name="line_id"
                class="form-select form-select-lg"
                required>
          <option value="">Select line</option>
          {% for l in lines %}
            <option value="{{ l.id }}">{{ l.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-6">
        <label class="form-label fw-semibold">Planned Quantity</label>
        <input type="number"
               name="plan_qty"
               min="1"
               class="form-control form-control-lg"
               placeholder="Enter target quantity"
               required>
      </div>
    </div>

    <!-- -------- ACTION -------- -->
    <div class="mt-4">
      <button class="btn btn-primary btn-lg w-100">
        Generate Allocation
      </button>
    </div>

  </div>
</form>
{% endif %}

<!-- ======================================================
     RESULTS SECTION
====================================================== -->
{% for r in result %}
<div class="card card-accent mb-5">

{% if r.error %}
  <div class="alert alert-danger">
    {{ r.error }}
  </div>
{% endif %}
  
  <!-- ================= SUMMARY HEADER ================= -->
  <div class="card-header py-3">
    <div class="row align-items-center">

      <!-- LINE NAME -->
      <div class="col-md-4">
        <div class="text-muted small">Assembly Line</div>
        <div class="fs-4 fw-bold">{{ r.line }}</div>
      </div>

      <!-- SUMMARY STRIP -->
      <div class="col-md-6">
        <div class="row text-center">

          <div class="col summary-item">
            <div class="summary-label">Plan Qty</div>
            <div class="summary-value">{{ r.plan }}</div>
          </div>

          <div class="col summary-item">
            <div class="summary-label">Takt Time</div>
            <div class="summary-value">{{ r.takt }} s</div>
          </div>

          <div class="col summary-item">
            <div class="summary-label">Shift</div>
            <div class="summary-value">{{ r.shift }} min</div>
          </div>

        </div>
      </div>

      <!-- MANPOWER -->
      <div class="col-md-2 text-center">
        <div class="text-muted small">Manpower Used</div>
        <div class="display-6 fw-bold text-primary">
          {{ r.manpower_used }}
        </div>
      </div>

    </div>
  </div>

  <!-- ================= BODY ================= -->
  <div class="card-body">

    <!-- ================= ALERTS ================= -->
    {% set alerts = [] %}
    {% for op in r.operators %}
      {% if op.status == 'over' %}
        {% set _ = alerts.append(op.name ~ " overloaded (" ~ op.time ~ " sec)") %}
      {% elif op.status == 'under' %}
        {% set _ = alerts.append(op.name ~ " underutilized (" ~ op.time ~ " sec)") %}
      {% endif %}
    {% endfor %}

    {% if alerts %}
      <div class="alert alert-warning mb-4">
        <strong>Review Required</strong>
        <ul class="mb-0 mt-2">
          {% for a in alerts %}
            <li>{{ a }}</li>
          {% endfor %}
        </ul>
      </div>
    {% else %}
      <div class="alert alert-success mb-4">
        All operators are within acceptable takt limits.
      </div>
    {% endif %}

    <!-- ================= ALLOCATION TABLE ================= -->
    <div class="table-responsive">

      <div class="text-muted small mb-2">
        ðŸŸ¢ OK (â‰¤ Takt) &nbsp;&nbsp; ðŸ”´ Overload &nbsp;&nbsp; ðŸŸ¡ Underutilized
      </div>

      <table class="table table-sm table-hover">
        <thead>
          <tr>
            <th style="width:8%">OP</th>
            <th>Assigned Activities</th>
            <th style="width:12%">Time (sec)</th>
            <th style="width:8%">Status</th>
          </tr>
        </thead>

        <tbody>
        {% for op in r.operators %}
          <tr class="
            {% if op.status == 'over' %}
              table-danger-soft
            {% elif op.status == 'under' %}
              table-warning-soft
            {% else %}
              table-success-soft
            {% endif %}
          ">
            <td class="fw-bold align-top">{{ op.name }}</td>

            <td>
              <ol class="mb-0 ps-3">
                {% for a in op.acts %}
                  <li class="mb-1">
                    <span class="fw-semibold">{{ a.text }}</span>
                  </li>
                {% endfor %}
              </ol>
            </td>

            <td class="fw-semibold align-top">{{ op.time }}</td>

            <td class="align-top">
              {% if op.status == 'over' %}ðŸ”´
              {% elif op.status == 'under' %}ðŸŸ¡
              {% else %}ðŸŸ¢{% endif %}
            </td>
          </tr>
        {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- ================= ACTIONS ================= -->
    <hr class="my-4">

    <div class="d-flex justify-content-between align-items-center">

      <div class="d-flex gap-2">
        <form method="post" action="{{ url_for('export_daily_plan') }}">
          <input type="hidden" name="shift" value="{{ request.form.get('shift') }}">
          <input type="hidden" name="line_id" value="{{ request.form.get('line_id') }}">
          <input type="hidden" name="plan_qty" value="{{ request.form.get('plan_qty') }}">
          <button class="btn btn-success btn-sm">
            Export Excel
          </button>
        </form>

        <form method="post"
              action="{{ url_for('print_daily_plan') }}"
              target="_blank">
          <input type="hidden" name="shift" value="{{ request.form.get('shift') }}">
          <input type="hidden" name="line_id" value="{{ request.form.get('line_id') }}">
          <input type="hidden" name="plan_qty" value="{{ request.form.get('plan_qty') }}">
          <button class="btn btn-outline-primary btn-sm">
            Print (A4)
          </button>
        </form>
      </div>

      <a href="{{ url_for('daily_plan') }}"
         class="btn btn-outline-secondary btn-sm">
        Clear & New Plan
      </a>

    </div>

  </div>
</div>
{% endfor %}

{% endblock %}
